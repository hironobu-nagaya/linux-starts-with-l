chapter=2
story=39
title=プロセス優先度
keyword=nice
keyword=renice
keyword=top
prev=2/38/
prev-title=プロセス操作
next=2/40/
next-title=シェル変数

# プロセス優先度

みどり（通常）：
  お兄ちゃん！
  重たい処理を動かしたら
  他の処理に影響が出たんだ！
  キー入力にラグが出たりして
  使いにくよ…
  なんとかならないかな？
しげる（通常）：
  もちろん対応できるよ
  今回はプロセスの
  優先度を学んでいこう！

## NICE値と優先度

しげる（通常）：
  「NICE値」はプロセスの
  優先度を決める数値だよ
  `-20` ～ `19` の範囲の
  整数で指定するんだ
  大きな値ほど優先度が低くなるよ
しげる（通常）：
  「優先度(priority)」は
  「NICE値 + 20」で決められるよ
みどり（通常）：
  プロセスの優先度は
  `0` ～` 39` の40段階なんだね
  こっちも大きいほど
  優先度が低くなるんだ
しげる（通常）：
  NICE値のデフォルトは `0` だよ
  優先度で表すと `20` ということだね
  プロセスのNICE値を変えることで
  優先度を管理するんだ

## `nice` コマンド

しげる（通常）：
  `nice` はNICE値を設定して
  コマンドを実行してくれるんだ

```bash
nice [-n NICE値] コマンド
```

しげる（通常）：
  NICE値が指定されなければ
  `10` が指定されるよ
みどり（通常）：
  こうやって優先度を下げて
  コマンドを実行できるんだね
みどり（通常）：
  逆に優先度を上げることも
  できるのかな？
しげる（通常）：
  プロセスの優先度を上げるのは
  管理者の仕事なんだ
  一般ユーザは優先度を
  下げるしかできないよ

## `renice` コマンド

みどり（通常）：
  プロセスの優先度は
  動かしたタイミングでしか
  設定できないのかな？
みどり（通常）：
  動かしたけど重たくて
  優先度を下げたいという場合も
  あると思うんだけど…
しげる（通常）：
  そういうときは
  `renice` を使うよ
  動いているプロセスの
  優先度を変更するんだ

```bash
renice [-n NICE値] PID...
```

しげる（通常）：
  NICE値の指定を `+5` とすれば
  「現在の値から `5` 増加」
  といった指定も可能だよ
みどり（笑顔）：
  プロセスが動いた後も
  NICE値を変更できるんだね！

## 実践

しげる（通常）：
  では実際にNICE値の
  変更をしてみよう！
みどり（通常）：
  重たい作業を試したいんだけど
  どんなコマンドがいいかな？
しげる（通常）：
  `yes > /dev/null` は
  負荷をかける目的で
  使われることがあるんだ
  このコマンドにNICE値を指定して
  バックグラウンド実行してみよう

```bash
nice -n 5 yes > /dev/null &
```

みどり（通常）：
  実行したよ！

```console
[1] 4986
```

みどり（通常）：
  ジョブ番号と
  PID が表示されたね！
しげる（通常）：
  `top` はプロセスの
  CPU やメモリの使用状況を
  表示してくれるんだ
  `top` で確認してみよう

```bash
top
```

みどり（通常）：
  うん、実行するね！

```console
PID  USER     PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
...
4986 midori   25   5    3740   1792   1792 R  99.0   0.0   2:11.35 yes
...
```

みどり（驚き）：
  おお！
  `yes` が CPU を
  食ってるね！
しげる（通常）：
  `PR` と `NI` という
  項目を見てみよう
  これが「優先度」と
  「NICE値」を表しているよ
みどり（通常）：
  優先度は `25` で
  NICE値が `5` だね！
  指定どおりのNICE値だし
  優先度も定義どおりの値だね！
しげる（通常）：
  `top` は `q` で終了するよ
みどり（通常）：
  うん！
  元のシェルの画面に戻ったよ！
しげる（通常）：
  今度は `renice` で
  プロセスのNICE値を
  変更してみよう

```bash
renice -n 19 4986
```

みどり（通常）：
  うん！

```console
4986 (process ID) old priority 5, new priority 19
```

みどり（通常）：
  「`5` から `19` に変わった」
  と表示が出たよ！
しげる（通常）：
  これで `nice` と `renice` を試せたね
  `yes` プロセスは CPU を占有し続けるので
  確認が済んだら停止させよう

```bash
kill 4986
```

みどり（笑顔）：
  これで後片付けも
  完了だね！

## まとめ

みどり（通常）：
  今回はプロセスの
  優先度を表すNICE値と
  それを変更する
  `nice`, `renice` を学んだよ！
しげる（通常）：
  NICE値からプロセスの優先度を管理するよ
  重たいけど急がないプロセスがあれば
  優先度を下げて他の作業に支障が
  出ないようにしよう！

