chapter=6
story=4
title=メモリ
keyword=memory
keyword=free
keyword=vmstat
prev=6/3/
prev-title=CPU
next=6/5/
next-title=ストレージ

# メモリ

みどり（通常）：
  前回は CPU リソースの
  調べ方を教えてもらったよ！
しげる（通常）：
  今回はメモリリソースの
  見方を学んでいこう

## `free` コマンド

しげる（通常）：
  `free` は
  メモリの利用状況を
  表示するよ

```bash
free [オプション]...
```

オプション      | 役割
--------------- | ----
`-h`, `--human` | 数値を人間に読みやすい形式で表示

みどり（通常）：
  「人間に読みやすい形式」って？
しげる（通常）：
  「人間に読みやすい(human-readable)形式」は
  数値に接尾辞(`K`, `M`, `G` など)を付けて
  短い値を表示をするよ
  例えば `20000000000` を
  `20G` のように表示するんだ
  大きな数値を扱うコマンドには
  たいていこのオプションがあるよ
みどり（驚き）：
  おおっ！
  これは親切！
しげる（通常）：
  では `free` を
  `-h` オプションと一緒に
  実行してみよう！

```bash
free -h
```

みどり（通常）：
  うん！

```console
               total        used        free      shared  buff/cache   available
Mem:           7.9Gi       1.3Gi       5.3Gi       7.0Mi       1.3Gi       6.5Gi
Swap:          199Mi          0B       199Mi
```

みどり（通常）：
  `Mem:` と
  `Swap:` の
  2行があるね？
しげる（通常）：
  `Mem:` は「実メモリ」
  `Swap:` は「スワップ領域」を表すよ
みどり（通常）：
  「実メモリ」はわかるとして
  「スワップ領域」ってなんなのかな？
しげる（通常）：
  ストレージ上の領域で
  メモリ上のデータを退避する場所なんだ
  メモリに十分な空きが無い場合に使われるので
  スワップ領域が使われるのは
  メモリ不足のサインだよ
みどり（通常）：
  へぇ…
  この行だけでも
  メモリの状況がわかるんだね！
しげる（通常）：
  次は個々の項目を
  説明していくよ

項目       | 意味
---------- | ----
total      | 総メモリ容量
used       | 利用中のメモリ容量(= total - free - buff/cache)
free       | プロセスなどで利用されいる容量
shared     | 主に tmpfs で使用されているメモリ容量
buff/cache | バッファやキャッシュに使われているメモリ容量
available  | 必要があればすぐに空けられるメモリ容量

みどり（通常）：
  tmpfs って何かな？
しげる（通常）：
  メモリ領域をファイルシステムとして
  扱う仕組みのことなんだ
  `/run` で使われている場合が多いよ
  能動的に使っていなければ
  ほとんど影響ないので
  あまり気にしなくてもいい項目だよ
みどり（通常）：
  バッファやキャッシュとは？
しげる（通常）：
  作業などで使ったデータだけど
  「再利用の可能性がある」などの理由で
  メモリ上に残されているデータだよ
  キャッシュを使い回すことで
  同様の処理を省いて
  高速化できる場合があるんだ
みどり（通常）：
  used の値が total にかなり近いね
  メモリに空きがあまり無いのかな？
しげる（通常）：
  メモリに空きがあると
  効率を上げるために
  バッファやキャッシュとして
  積極的に使われるんだ
  メモリに余裕があっても
  used と total が近いことはよくあるよ
しげる（通常）：
  メモリの空きに余裕があるかどうかは
  available が十分あるかどうかで
  判断するといいよ

## `vmstat` コマンド

しげる（通常）：
  `vmstat` は
  より詳細な
  メモリ使用状況を
  表示するよ

```bash
vmstat [オプション]... [間隔[回数]]
```

```console
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 5  0      0 5545200 131408 1277248    0    0     0     5  189   58 59  0 41  0  0
```

しげる（通常）：
  ただ通常はここまで詳細な情報が
  必要になることはないよ
  こういうコマンドがあると
  いうことだけ覚えておこう
みどり（通常）：
  使う必要が出たら
  `man` で調べるね！

```bash
man vmstat
```

## `watch` コマンド

しげる（通常）：
  `watch` は
  指定されたコマンドを定期実行して
  出力をフルスクリーン表示するよ
  `free` や `vmstat` と一緒に
  使われることが多いんだ

```bash
watch [オプション]... コマンド
```

オプション                   | 役割
---------------------------- | ----
`-n 秒数`, `--interval 秒数` | 指定された秒数ごとに更新(デフォルトは2秒)

みどり（通常）：
  へぇ…
  どんなものだろう？
しげる（通常）：
  これは動かして見たほうが早いよ
  `free` と一緒に使ってみよう！

```bash
watch -n 1 free -h
```

みどり（通常）：
  うん！

```console
Every 1.0s: free -h                             carter: Mon Jan 13 18:33:40 2025

               total        used        free      shared  buff/cache   available
Mem:           7.9Gi       758Mi       5.9Gi       7.0Mi       1.4Gi       7.1Gi
Swap:          199Mi          0B       199Mi
```

みどり（通常）：
  おお！
  出力内容が定期的に更新されて
  `top` と似たような
  感じになるんだね！
しげる（通常）：
  終了は Ctrl + C だよ！

## まとめ

みどり（通常）：
  今回はメモリリソースを
  確認する方法を学んだよ！
  `free` や `vmstat` で状況を知れるよ
みどり（通常）：
  メモリ不足は以下の状況から
  読み取れるんだね！

1. available の不足
2. スワップ領域の利用

しげる（通常）：
  メモリが不足するとシステムの動作が大幅に遅くなるよ
  また「OOM Killer(out-of-memory killer)」という
  プロセスを止めてメモリを空ける仕組みが動き出すんだ
  メモリが不足したらメモリを消費しているプロセスを
  停止させるのが一般的な対応だよ

