chapter=3
story=25
title=一時ファイル作成
keyword=shell script
keyword=temporary file
keyword=mktemp
prev=3/24/
prev-title=setコマンド
next=3/26/
next-title=シグナル処理

# 一時ファイル作成

みどり（通常）：
  お兄ちゃん！
  `/tmp` 配下に一時ファイルを作ると
  名前がかぶって困ることがあるんだ！
みどり（通常）：
  `/tmp` 配下は誰でも
  ファイルを作れるので
  名前がかぶることは
  仕方ないと思うんだけど…
  どうしたらいいかな？
しげる（通常）：
  いくつか方法があるよ
  今回は名前がかぶらない
  一時ファイルを
  作る方法を学ぼう！

## `$` 変数

しげる（通常）：
  `$` 変数には
  「シェルのPID」が代入されているんだ
  シェルスクリプトの場合には
  それを解釈しているシェルの PID だね
  これを一時ファイルの名前に含めれば
  名前がかぶる心配はほぼ無くなるよ
みどり（通常）：
  PID はプロセスの
  一意となる番号だったよね
  PID を名前に含めれば
  問題を解決できそう！
しげる（通常）：
  以下のように
  したらどうだろう？

```bash
#!/bin/bash

!start-class-silver!# 一時ファイル作成!end!
TEMP_FILE="/tmp/${0##*/}.$$"
touch "$TEMP_FILE"

!start-class-silver!# 一時ファイルを使う処理!end!
...

!start-class-silver!# 一時ファイル削除!end!
rm "$TEMP_FILE"
```

みどり（通常）：
  `${0##*/}.$$` で
  `スクリプト名.シェルのPID` という
  一時ファイル名にしているんだ！
  これならかぶる心配がなさそうだね！

## `mktemp` コマンド

しげる（通常）：
  `$` 変数を使えば
  名前がかぶる心配は
  ほぼ無くなるけど
  ゼロではないんだ
みどり（通常）：
  厳密なスクリプトだと
  困ることがありそうだね
しげる（通常）：
  `mktemp` は
  名前がかぶらない
  一時ファイルを作るよ

```bash
mktemp [オプション]... テンプレート文字列
```

オプション | 役割
---------- | ----
`-d`       | ファイルではなくディレクトリを作成

みどり（通常）：
  `テンプレート文字列` は
  どう書くのかな？
しげる（通常）：
  普通のパスのように書けるよ
  ただし大文字の `X` が
  連続している箇所は
  一意となる文字列に
  置き換えられるんだ
みどり（通常）：
  作られたファイル名は
  どうやって知るのかな？
しげる（通常）：
  作成されたファイル名は
  標準出力に出力されるんだ
  なのでコマンド置換 `$( ... )` と
  一緒に使うといいよ
しげる（通常）：
  `mktemp` で
  一時ファイルを作る例を
  見てみよう！

```bash
#!/bin/bash

!start-class-silver!# 一時ファイル作成!end!
TEMP_FILE="$(mktemp "/tmp/${0##*/}.XXXXXXXX")"

!start-class-silver!# 一時ファイルを使う処理!end!
...

!start-class-silver!# 一時ファイル削除!end!
rm "$TEMP_FILE"
```

しげる（通常）：
  このスクリプトでは
  `/tmp/スクリプト名.ランダムな8文字`
  という名前の一時ファイルを作るよ
しげる（通常）：
  偶然名前がかぶってしまった場合
  ランダムな文字列を
  かぶらなくなるまで
  選び直してくれるんだ
みどり（笑顔）：
  この方法なら
  名前のかぶりは
  気にならなくなるね！

## まとめ

みどり（通常）：
  今回は一時ファイルの
  作り方を学んだよ！
  固定された名前は
  かぶる可能性があるので
  `$` 変数の値を名前に含めたり
  `mktemp` を使うんだ！
しげる（通常）：
  スクリプト実行中に
  一時ファイルを作る場合は
  これらを活用しよう！
  「一時ファイル」を
  「一時ディレクトリ」に
  置き換えても使えるよ

