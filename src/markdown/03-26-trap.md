chapter=3
story=26
title=シグナル処理
keyword=shell script
keyword=signal
keyword=trap
prev=3/25/
prev-title=一時ファイル作成
next=3/27/
next-title=ジョブ管理

# シグナル処理

みどり（通常）：
  お兄ちゃん！
  一時ファイルを作るスクリプトを
  Ctrl + C で止めると
  一時ファイルが残っちゃうよ！
みどり（通常）：
  スクリプトの最後の後処理で
  一時ファイルを削除しているので
  途中で止めたら残るのは
  仕方ないとは思うけど…
  なんとかならないかな？
しげる（通常）：
  「Ctrl + C」は
  「SIGINT(`2`)」を
  送信だったね
  今回はシグナルを
  処理する方法を学ぼう！

## `trap` コマンド

しげる（通常）：
  `trap` は
  シグナルの処理を定義するよ

```bash
trap ['コマンド'] シグナル番号...
```

しげる（通常）：
  シェルが指定された
  `シグナル番号` を受け取ったら
  `コマンド` を実行してくれるんだ
みどり（通常）：
  `trap` の `シグナル番号` に
  `2` を指定すれば
  Ctrl + C で止められたときの
  処理を指定できるんだね！
しげる（通常）：
  `trap` では
  特別なシグナル番号 `0` を指定できるんだ
  これは「スクリプトが終了したとき」に発せられるよ
  スクリプトの後処理などに使われるんだ
みどり（通常）：
  `0` 番はよく使いそうだね
  他に気をつけるシグナルはあるかな？
しげる（通常）：
  強制終了を表す
  「SIGKILL(`9`)」は
  処理できないんだ
  `trap` で `9` 番を指定しても
  `コマンド` は実行されず
  実行されているスクリプトは
  即時終了になるよ

## シグナルのリセット

みどり（通常）：
  一度 `trap` を設定すると
  解除できないのかな？
しげる（通常）：
  コマンドを省略すると
  `trap` をの設定を解除するよ
  以下はシグナル番号 `2` の
  `tarp` の設定を解除するんだ

```bash
trap 2
```

## シグナルの無視

しげる（通常）：
  指定するコマンドを
  空文字にすると
  そのシグナルに対して
  「何もしない」という
  指定ができるよ
  つまり指定されたシグナルを
  無視する動作になるんだ
しげる（通常）：
  以下は SIGHUP(`1`) を
  無視する設定だよ

```bash
trap '' 1
```

みどり（通常）：
  `nohup` と同じ挙動になるんだね！
  シグナルの「リセット」と「無視」は
  指定が似ているから気をつけなきゃ…

## 実践

しげる（通常）：
  ではシグナルが送信されても
  一時ファイルが後片付けされるような
  スクリプトを書いてみよう！

```bash
#!/bin/bash

!start-class-silver!# シグナル処理定義!end!
function cleanup() {
  [ -e "$TEMP_FILE" ] && rm -rf "$TEMP_FILE"
  exit "$1"
}

!start-class-silver!# シグナル処理設定!end!
trap 'cleanup 0' 0
trap 'cleanup 1' 1 2 3 15

!start-class-silver!# 一時ファイル作成!end!
TEMP_FILE="$(mktemp "/tmp/${0##*/}.XXXXXXXX")"

!start-class-silver!# 一時ファイルを使う処理!end!
...
```

しげる（通常）：
  このスクリプトでは
  シグナルを以下のように処理しているよ

シグナル名 | シグナル番号 | 意味                         | 終了ステータス
---------- | ------------ | ---------------------------- | --------------
-          | 0            | シェルスクリプト終了         | 0
SIGHUP     | 1            | 端末の接続切れを通知         | 1
SIGINT     | 2            | キーボード割り込み(Ctrl + C) | 1
SIGQUIT    | 3            | キーボード中止(Ctrl + /)     | 1
SIGTERM    | 15           | 終了                         | 1

みどり（通常）：
  これまで一番最後にあった
  一時ファイルの後処理は
  書かなくてもいいんだね！
しげる（通常）：
  シェルスクリプト終了時に
  `0` 番のシグナルが送られるからね
  `trap` で `0` 番を
  処理すると決めておくと
  書かなくても良くなるんだ
みどり（通常）：
  `cleanup` 関数を
  定義しているみたいだけど？
しげる（通常）：
  `trap` で指定する `コマンド` は
  1行である必要があるんだ
  この `コマンド` を
  関数にしてあげることで
  複数行の処理を書けるようになるんだ
  `trap` でよく使われる書き方だよ！

## まとめ

みどり（通常）：
  今回はシェルスクリプトで
  シグナルを扱う方法を学んだよ！
  `trap` を使って定義してあげるんだね！
しげる（通常）：
  `trap` が実行されてから
  シグナルを扱えるようになるんだ
  なのでなるべくスクリプトの冒頭で
  実行してあげるようにしよう！

