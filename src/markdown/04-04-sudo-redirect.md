chapter=4
story=4
title=sudoとリダイレクト
keyword=super user
keyword=root
keyword=sudo
keyword=tee
keyword=redirect
prev=4/3/
prev-title=sudoコマンド
next=4/5/
next-title=電源管理

# `sudo` とリダイレクト

みどり（通常）：
  お兄ちゃん！
  `sudo` とリダイレクトを
  組み合わせると
  エラーになることがあるんだ
  原因わかるかな？
しげる（通常）：
  それは `sudo` を使い始めの頃に
  多くの人がつまずくポイントだよ
しげる（通常）：
  今回は `sudo` と
  リダイレクトの仕組みと
  その解決方法を
  詳しく見てみよう

# `sudo` とリダイレクトの問題

みどり（通常）：
  このコマンドを試したら
  失敗しちゃったんだ…

```bash
sudo cat > /etc/my-setting << EOF
USERNAME=midori
PASSWORD=irodim
EOF
```

しげる（通常）：
  `/etc` 配下に
  ファイルを作ろうと
  したんだね
みどり（通常）：
  実行結果は
  こうだったよ

```console
-bash: /etc/my-setting: Permission denied
```

みどり（通常）：
  スーパーユーザはパーミッションを
  無視できるんだよね？
  でも「Permission denied」と表示されて
  操作が拒否されてしまうんだよ…
しげる（通常）：
  ではこのエラーの
  理由を説明するね
しげる（通常）：
  `sudo cat` は `cat` を
  スーパユーザ権限で
  実行しているんだ
みどり（通常）：
  うん！
  そうだよね！
しげる（通常）：
  でもその後の出力リダイレクト
  `> /etc/my-setting` は
  `sudo` の管理外だって
  気づいたかな？
みどり（驚き）：
  えっ…
  そうなの？
しげる（通常）：
  実はそうなんだ
  リダイレクトは
  `cat` ではなく
  シェルである `bash` が
  処理しているんだ
しげる（通常）：
  このシェルはみどりの権限で動いているから
  みどりが書き込めない場所へのリダイレクトは
  「Permission denied」に
  なっちゃうというわけだね
みどり（通常）：
  へぇ…
  勉強になるなぁ…
  でもこういう場合は
  どうすればいいのかな？

## `tee` を使う

しげる（通常）：
  `tee` を使えば
   この問題を回避できるよ
みどり（通常）：
  「同一ファイルへの入出力」のときに
  扱ったコマンドだね
  出力を「ファイル」と「標準出力」の
  両方に送るコマンドだったね
しげる（通常）：
  この `tee` に `sudo` をつけると
  書き込み権限が必要な場所に
  ファイルを出力できるよ

```bash
sudo tee /etc/my-setting << EOF
USERNAME=midori
PASSWORD=irodim
EOF
```

みどり（通常）：
  なるほど！
  `tee` がファイル出力を行うので
  `tee` に `sudo` を付けると
  ファイル出力がスーパユーザ権限で行われて
  書き込めるというわけなんだね！
しげる（笑顔）：
  標準出力に内容が表示されるけど
  どうしても気になるなら出力を
  `/dev/null` へリダイレクトしよう！

## `bash` を使う

しげる（通常）：
  もう一つはシェル全体を
  管理者権限で実行する方法だよ
しげる（通常）：
  `bash` の `-c` オプションは
  指定された文字列を
  コマンドとして実行するよ

```bash
bash -c 文字列
```
みどり（通常）：
  へぇ…
  でも指定する文字列がコマンドなら
  `bach -c` は無くても
  いいんじゃないかな？
しげる（通常）：
  普通ならそうだよね
  でもリダイレクトを使うと
  事情が変わってくるんだ

```bash
bash -c 'echo hello > /tmp/my-hello'
```

みどり（通常）：
  現行のシェルではなく
  コマンドで指定したシェル `bash` が
  リダイレクトをしてくれるんだね！
しげる（通常）：
  そういうことなんだ！
  その `bash` に `sudo` を付けると
  管理者権限でリダイレクトも含めた
  処理ができるんだ

```bash
sudo bash -c 'echo hello > /etc/my-hello'
```

みどり（驚き）：
  そっか！
  出力リダイレクトの処理も
  スーパユーザ権限で行われるので
  書き込めるというわけなんだね！
しげる（通常）：
  みどりの場合は
  このようにすれば動作するよ

```bash
sudo bash -c 'cat > /etc/my-setting << EOF
USERNAME=midori
PASSWORD=irodim
EOF'
```

みどり（通常）：
  ちゃんとリダイレクトを使っていて
  理にかなっている書き方だね
  でもこの方法は理解して慣れるまで
  少し時間がかかるかも…

## まとめ

みどり（通常）：
  今回は `sudo` と
  リダイレクトを組み合わせても
  自分の権限の範囲しか
  読み書きできないことを学んだよ
  この問題を回避するには
  `tee` や `bash -c` が使えるよ！
しげる（通常）：
  一見理解できない挙動も
  ちゃんと原理原則に則って動いているんだ
  そういったものを紐解くことで
  Linux の理解は進んでいくよ！

